{"version":3,"file":"lattice-connector.cjs.development.js","sources":["../src/index.ts"],"sourcesContent":["import { ConnectorUpdate } from '@web3-react/types'\r\nimport { AbstractConnector } from '@web3-react/abstract-connector'\r\nimport Web3ProviderEngine from 'web3-provider-engine'\r\nimport { LatticeSubprovider } from '@0x/subproviders/lib/src/subproviders/lattice'\r\nimport CacheSubprovider from 'web3-provider-engine/subproviders/cache.js'\r\nimport { RPCSubprovider } from '@0x/subproviders/lib/src/subproviders/rpc_subprovider' // https://github.com/0xProject/0x-monorepo/issues/1400\r\n\r\ninterface LatticeConnectorArguments {\r\n  chainId: number\r\n  url: string\r\n  pollingInterval?: number\r\n  requestTimeoutMs?: number\r\n  appName: string\r\n}\r\n\r\nexport class LatticeConnector extends AbstractConnector {\r\n  private readonly chainId: number\r\n  private readonly url: string\r\n  private readonly pollingInterval?: number\r\n  private readonly requestTimeoutMs?: number\r\n  private readonly appName: string\r\n  private provider: any\r\n\r\n  constructor({ chainId, url, pollingInterval, requestTimeoutMs, appName }: LatticeConnectorArguments) {\r\n    super({ supportedChainIds: [chainId] })\r\n\r\n    this.chainId = chainId\r\n    this.url = url\r\n    this.pollingInterval = pollingInterval\r\n    this.requestTimeoutMs = requestTimeoutMs\r\n    this.appName = appName\r\n  }\r\n\r\n  public async activate(): Promise<ConnectorUpdate> {\r\n    if (!this.provider) {\r\n      const LatticeKeyring = await import('eth-lattice-keyring').then(m => m?.default ?? m)\r\n      const engine = new Web3ProviderEngine({ pollingInterval: this.pollingInterval })\r\n      const opts = {\r\n        appName: this.appName,\r\n        latticeConnectClient: LatticeKeyring,\r\n        networkId: this.chainId\r\n      }\r\n      engine.addProvider(new LatticeSubprovider(opts))\r\n      engine.addProvider(new CacheSubprovider())\r\n      engine.addProvider(new RPCSubprovider(this.url, this.requestTimeoutMs))\r\n      this.provider = engine\r\n    }\r\n\r\n    this.provider.start()\r\n\r\n    return { provider: this.provider, chainId: this.chainId }\r\n  }\r\n\r\n  public async getProvider(): Promise<Web3ProviderEngine> {\r\n    return this.provider\r\n  }\r\n\r\n  public async getChainId(): Promise<number> {\r\n    return this.chainId\r\n  }\r\n\r\n  public async getAccount(): Promise<null> {\r\n    return this.provider._providers[0].getAccountsAsync(1).then((accounts: string[]): string => accounts[0])\r\n  }\r\n\r\n  public deactivate() {\r\n    this.provider.stop()\r\n  }\r\n\r\n  public async close(): Promise<null> {\r\n    this.emitDeactivate()\r\n    // Due to limitations in the LatticeSubprovider API, we use this code with `getAccounts`\r\n    // as a hack to allow us to close out the connection and forget data.\r\n    // It will get handled in `eth-lattice-keyring`, which will forget the device and return\r\n    // an empty array (whose first element will be null/undefined)\r\n    const CLOSE_CODE = -1000\r\n    return this.provider._providers[0].getAccountsAsync(CLOSE_CODE).then((accounts: string[]): string => accounts[0])\r\n  }\r\n}\r\n"],"names":["LatticeConnector","chainId","url","pollingInterval","requestTimeoutMs","appName","supportedChainIds","activate","provider","start","then","m","LatticeKeyring","engine","Web3ProviderEngine","opts","latticeConnectClient","networkId","addProvider","LatticeSubprovider","CacheSubprovider","RPCSubprovider","getProvider","getChainId","getAccount","_providers","getAccountsAsync","accounts","deactivate","stop","close","emitDeactivate","CLOSE_CODE","AbstractConnector"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAeaA,gBAAb;AAAA;;AAQE;;;QAAcC,eAAAA;QAASC,WAAAA;QAAKC,uBAAAA;QAAiBC,wBAAAA;QAAkBC,eAAAA;AAC7D,0CAAM;AAAEC,MAAAA,iBAAiB,EAAE,CAACL,OAAD;AAArB,KAAN;AAEA,UAAKA,OAAL,GAAeA,OAAf;AACA,UAAKC,GAAL,GAAWA,GAAX;AACA,UAAKC,eAAL,GAAuBA,eAAvB;AACA,UAAKC,gBAAL,GAAwBA,gBAAxB;AACA,UAAKC,OAAL,GAAeA,OAAf;;AACD;;AAhBH;;AAAA,SAkBeE,QAlBf;AAAA;mBAmBS;;;AAcL,eAAKC,QAAL,CAAcC,KAAd;;AAEA,eAAO;AAAED,UAAAA,QAAQ,EAAE,OAAKA,QAAjB;AAA2BP,UAAAA,OAAO,EAAE,OAAKA;AAAzC,SAAP;;;;YAhBI,CAAC,OAAKO;iCACqB,mEAAO,qBAAP,QAA8BE,IAA9B,CAAmC,UAAAC,CAAC;AAAA;;AAAA,iCAAIA,CAAJ,oBAAIA,CAAC,WAAL,yBAAkBA,CAAlB;AAAA,WAApC,kBAAvBC;AACN,gBAAMC,MAAM,GAAG,IAAIC,kBAAJ,CAAuB;AAAEX,cAAAA,eAAe,EAAE,OAAKA;AAAxB,aAAvB,CAAf;AACA,gBAAMY,IAAI,GAAG;AACXV,cAAAA,OAAO,EAAE,OAAKA,OADH;AAEXW,cAAAA,oBAAoB,EAAEJ,cAFX;AAGXK,cAAAA,SAAS,EAAE,OAAKhB;AAHL,aAAb;AAKAY,YAAAA,MAAM,CAACK,WAAP,CAAmB,IAAIC,0BAAJ,CAAuBJ,IAAvB,CAAnB;AACAF,YAAAA,MAAM,CAACK,WAAP,CAAmB,IAAIE,gBAAJ,EAAnB;AACAP,YAAAA,MAAM,CAACK,WAAP,CAAmB,IAAIG,8BAAJ,CAAmB,OAAKnB,GAAxB,EAA6B,OAAKE,gBAAlC,CAAnB;AACA,mBAAKI,QAAL,GAAgBK,MAAhB;;;;;;AAMH,KApCH;AAAA;AAAA;AAAA;;AAAA,SAsCeS,WAtCf;AAAA;mBAuCW;;AAAP,6BAAO,OAAKd,QAAZ;AACD,KAxCH;AAAA;AAAA;AAAA;;AAAA,SA0Cee,UA1Cf;AAAA;mBA2CW;;AAAP,6BAAO,OAAKtB,OAAZ;AACD,KA5CH;AAAA;AAAA;AAAA;;AAAA,SA8CeuB,UA9Cf;AAAA;mBA+CW;;AAAP,6BAAO,OAAKhB,QAAL,CAAciB,UAAd,CAAyB,CAAzB,EAA4BC,gBAA5B,CAA6C,CAA7C,EAAgDhB,IAAhD,CAAqD,UAACiB,QAAD;AAAA,eAAgCA,QAAQ,CAAC,CAAD,CAAxC;AAAA,OAArD,CAAP;AACD,KAhDH;AAAA;AAAA;AAAA;;AAAA,SAkDSC,UAlDT,GAkDS;AACL,SAAKpB,QAAL,CAAcqB,IAAd;AACD,GApDH;;AAAA,SAsDeC,KAtDf;AAAA;oBAuDI;;AAAA,cAAKC,cAAL;AAEA;AACA;AACA;;;AACA,UAAMC,UAAU,GAAG,CAAC,IAApB;AACA,6BAAO,QAAKxB,QAAL,CAAciB,UAAd,CAAyB,CAAzB,EAA4BC,gBAA5B,CAA6CM,UAA7C,EAAyDtB,IAAzD,CAA8D,UAACiB,QAAD;AAAA,eAAgCA,QAAQ,CAAC,CAAD,CAAxC;AAAA,OAA9D,CAAP;AACD,KA9DH;AAAA;AAAA;AAAA;;AAAA;AAAA,EAAsCM,mCAAtC;;;;"}